var ADMIN_CODES=["country","adminCode1","adminCode2","adminCode3","continentCode"],BBOX=["east","west","north","south"];L.Control.Geonames=L.Control.extend({includes:L.Mixin.Events,_active:!1,_resultsList:null,_marker:null,_popup:null,_hasResults:!1,options:{username:"",maxresults:5,zoomLevel:null,className:"leaflet-geonames-icon",workingClass:"leaflet-geonames-icon-working",featureClasses:["A","H","L","P","R","T","U","V"],baseQuery:"isNameRequired=true",position:"topleft",showMarker:!0,showPopup:!0,adminCodes:{},bbox:{},lang:"en"},onAdd:function(){this._container=L.DomUtil.create("div","leaflet-geonames-search leaflet-bar"),this._container.title="Search by location name";var a=this._link=L.DomUtil.create("a",this.options.className,this._container);a.href="#";var b=L.DomUtil.create("form","",this._container);L.DomEvent.addListener(b,"submit",this._search,this);var c=this._input=L.DomUtil.create("input","",b);return c.type="text",c.placeholder="Enter a location name",this._resultsList=L.DomUtil.create("ul","",this._container),L.DomEvent.on(this._container,"dblclick",L.DomEvent.stop).on(this._container,"click",L.DomEvent.stop).on(this._container,"mousedown",L.DomEvent.stopPropagation).on(a,"click",function(){this._active=!this._active,this._active?(L.DomUtil.addClass(this._container,"active"),c.focus(),this._hasResults&&L.DomUtil.addClass(this._resultsList,"hasResults")):this._close()},this),this._container},addPoint:function(a){var b=parseFloat(a.lat),c=parseFloat(a.lng);if(this.options.showMarker||this.options.showPopup){var d=this.options.zoomLevel||this._map.getMaxZoom();this._map.setView([b,c],d,!1)}null!=this._marker&&(this._map.removeLayer(this._marker),this._marker=null),null!=this._tooltip&&(this._map.closePopup(this._tooltip),this._tooltip=null),this.options.showMarker?(this._marker=L.marker([b,c]).addTo(this._map),this.options.showPopup&&(this._marker.bindPopup(this._getName(a)),this._marker.openPopup())):this.options.showPopup&&(this._popup=L.popup().setLatLng([b,c]).setContent(this._getName(a)).openOn(this._map))},_close:function(){L.DomUtil.removeClass(this._container,"active"),L.DomUtil.removeClass(this._resultsList,"hasResults"),L.DomUtil.removeClass(this._resultsList,"noResults"),this._active=!1,null!=this._marker&&(this._map.removeLayer(this._marker),this._marker=null),null!=this._popup&&(this._map.closePopup(this._popup),this._popup=null)},_search:function(a){L.DomEvent.preventDefault(a),L.DomUtil.addClass(this._link,this.options.workingClass),L.DomUtil.removeClass(this._resultsList,"noResults"),this._hasResults=!1,this._resultsList.innerHTML="";var b,c,d="function"==typeof this.options.bbox?this.options.bbox():this.options.bbox;for(b in BBOX)if(!d[BBOX[b]]){d=null;break}var e={q:this._input.value,lang:this.options.lang};for(c in this.options.adminCodes)if(-1!=ADMIN_CODES.indexOf(c)){var f=this.options.adminCodes[c];e[c]="function"==typeof f?f():f}if(d)for(b in BBOX)c=BBOX[b],e[c]=d[c];this.fire("search",{params:e});var g={username:this.options.username,maxRows:this.options.maxresults,style:"LONG"},h="//api.geonames.org/searchJSON?"+this._objToQuery(g)+"&"+this._objToQuery(e);this.options.featureClasses&&this.options.featureClasses.length&&(h+="&"+this.options.featureClasses.map(function(a){return"featureClass="+a}).join("&")),this.options.baseQuery&&(h+="&"+this.options.baseQuery);var i=this,j="geonamesSearchCallback";this._jsonp(h,function(a){document.body.removeChild(document.getElementById("getJsonP")),delete window[j],i._processResponse(a)},j)},_objToQuery:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},_jsonp:function(a,b,c){c=c||"jsonpCallback",window[c]=b,a+="&callback="+c;var d=document.createElement("script");d.id="getJsonP",d.src=a,d.async=!0,document.body.appendChild(d)},_processResponse:function(a){if(L.DomUtil.removeClass(this._link,this.options.workingClass),a.geonames.length>0){L.DomUtil.addClass(this._resultsList,"hasResults"),this._hasResults=!0;var b;a.geonames.forEach(function(a){b=L.DomUtil.create("li","",this._resultsList),b.innerHTML=this._getName(a),L.DomEvent.addListener(b,"click",function(){this.fire("select",{geoname:a}),this.addPoint(a)},this)},this)}else L.DomUtil.addClass(this._resultsList,"noResults"),b=L.DomUtil.create("li","",this._resultsList),b.innerText="No results found"},_getName:function(a){var b,c=a.name;return["adminName1","countryName"].forEach(function(d){b=a[d],b&&""!=b&&b!=a.name&&(c+=", "+b)},this),c}}),L.control.geonames=function(a){return new L.Control.Geonames(a)};